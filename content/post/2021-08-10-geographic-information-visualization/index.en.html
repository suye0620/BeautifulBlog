---
title: åœ°ç†ä¿¡æ¯å¯è§†åŒ–â€”â€”ggplotç»˜åˆ¶ç¾å¸æŸç§åœ°åŒºæŒ‡æ ‡çƒ­åŠ›å›¾
author: è‹çƒ¨
date: '2021-08-10'
slug: geographic-information-visualization
categories:
  - æ–‡ç« 
tags:
  - plot
  - R Markdown
cover: /img/GIV/fig4-1.png
output:
  blogdown::html_page:
    toc: true
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>

<div id="TOC">
<ul>
<li><a href="#å‰è¨€">0 å‰è¨€</a></li>
<li><a href="#é—®é¢˜åŠæ•°æ®é›†ç®€ä»‹">1 é—®é¢˜åŠæ•°æ®é›†ç®€ä»‹</a></li>
<li><a href="#æ¢ç´¢æ€§æ•°æ®åˆ†æ">2 æ¢ç´¢æ€§æ•°æ®åˆ†æ</a>
<ul>
<li><a href="#åˆ†ç±»å˜é‡å¯¹è¢«é¢„æµ‹å˜é‡çš„å½±å“">2.1 åˆ†ç±»å˜é‡å¯¹è¢«é¢„æµ‹å˜é‡çš„å½±å“</a></li>
<li><a href="#ä»¥å·ä¸ºå•ä½æŸ¥çœ‹å®¢æˆ·æµå¤±æƒ…å†µ">2.2 ä»¥å·ä¸ºå•ä½æŸ¥çœ‹å®¢æˆ·æµå¤±æƒ…å†µ</a></li>
</ul></li>
</ul>
</div>

<div id="å‰è¨€" class="section level1">
<h1>0 å‰è¨€</h1>
<p><span class="math inline">\(\quad\quad\)</span>æœ¬ç¯‡æƒ³æ³•æºè‡ªäºå¤§äºŒä¸‹å­¦æœŸä¸€æ¬¡æœºå™¨å­¦ä¹ è¯¾ç¨‹çš„ä½œä¸šå†…å®¹ï¼Œä½œä¸šä¸­æˆ‘æƒ³è¦ç»˜åˆ¶ç¾å›½å„å·åœ°å›¾ï¼Œå¹¶åœ¨å„å·ä¸Šç”¨é¢œè‰²æ·±æµ…æ ‡è¯†çƒ­åº¦ã€‚ä¸ºäº†è¾¾åˆ°å¦‚å›¾ <a href="#fig:fig1">1</a> æ˜¾ç¤ºçš„æ•ˆæœï¼Œæˆ‘ç£•äº†å¤§åŠå¤©(æ²¡è®°é”™çš„è¯ï¼Œä»ä¸‹åˆ3ï¼š00-æ™šä¸Š12ï¼š00)ï¼Œè·Ÿå‰é¢è·‘æ•°æ®èŠ±çš„æ—¶é—´ä¸€æ ·é•¿ğŸ˜‚ã€‚ä¸ºä»€ä¹ˆèŠ±äº†è¿™ä¹ˆä¹…ï¼Œä¸»è¦åŸå› å°±æ˜¯ç½‘ä¸Šå¤§éƒ¨åˆ†æ–¹æ³•éƒ½å·²ç»å¤±æ•ˆï¼Œå†åŠ ä¸Šè‡ªå·±æ²¡æœ‰ç”¨è¿‡åœ°ç†shpå‹çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ±äº†å¾ˆå¤šæ—¶é—´è°ƒbugã€‚(<s>è‡ªå·±å†™çš„Bugå°±æ˜¯è¿™ä¹ˆå¤š</s>)</p>
<div class="figure" style="text-align: center"><span id="fig:fig1"></span>
<img src="pic/stateåˆ†ç±».png" alt="ä½œå›¾æ ·ä¾‹" width="645" />
<p class="caption">
å›¾ 1: ä½œå›¾æ ·ä¾‹
</p>
</div>
</div>
<div id="é—®é¢˜åŠæ•°æ®é›†ç®€ä»‹" class="section level1">
<h1>1 é—®é¢˜åŠæ•°æ®é›†ç®€ä»‹</h1>
<p><span class="math inline">\(\quad\quad\)</span>ç¾å›½ä½œä¸ºå‘è¾¾å›½å®¶ï¼Œå…¶ç”µä¿¡å¸‚åœºå·²ç»é¥±å’Œï¼Œå®¢æˆ·å¢é•¿ç‡ä½ã€‚å› æ­¤ï¼Œå¸‚åœºå‚ä¸è€…çš„ä¸»è¦å…³æ³¨ç‚¹æ˜¯æ§åˆ¶ç”µä¿¡å®¢æˆ·æµå¤±ç‡ã€‚æœ¬æ–‡å°†é€šè¿‡æ¢ç´¢Rè¯­è¨€C50åŒ…ä¸­çš„Churnæ•°æ®é›†ï¼Œä»¥ç¡®å®šå½±å“å®¢æˆ·æµå¤±çš„å…³é”®å› ç´ ï¼Œå¹¶æ„å»ºæœ€ä½³é¢„æµ‹æ¨¡å‹æ¥é¢„æµ‹æµå¤±ã€‚</p>
</div>
<div id="æ¢ç´¢æ€§æ•°æ®åˆ†æ" class="section level1">
<h1>2 æ¢ç´¢æ€§æ•°æ®åˆ†æ</h1>
<p><span class="math inline">\(\quad\quad\)</span>Churn æ•°æ®é›†åˆ†ä¸º churnTrain (3333 obs.) å’Œ churnTest (1667 obs.)ï¼ŒåŒ…å« 19 ä¸ªé¢„æµ‹å˜é‡å’Œ 1 ä¸ªå“åº”å˜é‡ï¼ˆchurn = yes/noï¼‰ã€‚æµå¤±å®¢æˆ·çš„æ¯”ä¾‹ï¼ˆchurn = yesï¼‰æ¥è¿‘ 14%ï¼Œå¹¶ä¸”å‡åŒ€åˆ†å¸ƒåœ¨2ä¸ªé›†åˆä¸­ã€‚å…¶ä¸­churnTrainå°†ç”¨äºæ•°æ®æ¢ç´¢å’Œæ¨¡å‹æ„å»ºï¼Œè€Œ churnTest å°†ç”¨äºè¡¡é‡æ¨¡å‹æ€§èƒ½ã€‚</p>
<div id="åˆ†ç±»å˜é‡å¯¹è¢«é¢„æµ‹å˜é‡çš„å½±å“" class="section level2">
<h2>2.1 åˆ†ç±»å˜é‡å¯¹è¢«é¢„æµ‹å˜é‡çš„å½±å“</h2>
<pre class="r"><code># ä½¿ç”¨data.tableè¿›è¡Œåç»­è®¡ç®—
dt_churn_train &lt;- setDT(churnTrain)
dt_churn_test &lt;- setDT(churnTest)</code></pre>
<pre class="r"><code># å°†åœ°åŒºç¼–ç è½¬åŒ–ä¸ºå› å­
dt_churn_train[,area_code:=factor(area_code)]
dt_churn_test[,area_code:=factor(area_code)]

# ç»˜åˆ¶å„ä¸ªå­å›¾
ax1 &lt;- ggplot(dt_churn_train, aes(area_code, fill = churn)) +
  geom_bar(position = &quot;fill&quot;) + labs(x = &quot;Area code&quot;, y = &quot;&quot;) +
  theme(legend.position = &quot;none&quot;)
ax2 &lt;- ggplot(dt_churn_train, aes(international_plan, fill = churn)) +
  geom_bar(position = &quot;fill&quot;) + labs(x = &quot;International?&quot;, y = &quot;&quot;) +
  theme(legend.position = &quot;none&quot;)
ax3 &lt;- ggplot(dt_churn_train, aes(voice_mail_plan, fill = churn)) +
  geom_bar(position = &quot;fill&quot;) + labs(x = &quot;Voicemail?&quot;, y = &quot;&quot;) +
  theme(legend.position = &quot;none&quot;) 
ax4 &lt;- ggplot(dt_churn_train, aes(number_customer_service_calls, 
                                  fill = churn)) + 
  geom_bar(position = &quot;fill&quot;) + labs(x = &quot;Customer calls&quot;, y = &quot;&quot;) +
  theme(legend.position = &quot;none&quot;) 

# æ•´å›¾åˆå¹¶
gridExtra::grid.arrange(ax1, ax2, ax3, ax4, ncol = 4, nrow = 1, 
                        top = &quot;Churn/Non-churn Proportion&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p><span class="math inline">\(\quad\quad\)</span>ä¸Šå›¾æ˜¾ç¤ºäº†åˆ†ç±»é¢„æµ‹å˜é‡çš„æµå¤±æ¯”ä¾‹ï¼ˆçº¢è‰²å³ä¸ºæµå¤±ï¼‰ã€‚æŒ‰åŒºå·åˆ’åˆ†çš„æµå¤±ç‡ä¸æ€»ä½“æµå¤±ç‡æ²¡æœ‰åŒºåˆ«ï¼Œè€Œæœªä½¿ç”¨è¯­éŸ³é‚®ä»¶è®¡åˆ’çš„å®¢æˆ·çš„æµå¤±ç‡ä¼¼ä¹æ›´é«˜ã€‚å¼€é€šå›½é™…æ¼«æ¸¸çš„å®¢æˆ·æµå¤±ç‡æ˜¯å¹³å‡æ°´å¹³çš„4å€ï¼Œå¹¶ä¸”å®¢æœç”µè¯æ¬¡æ•°è¶…è¿‡4æ¬¡æ—¶ï¼Œå®¢æˆ·æµå¤±ç‡ä¼šæ˜¾ç€å¢åŠ ã€‚</p>
</div>
<div id="ä»¥å·ä¸ºå•ä½æŸ¥çœ‹å®¢æˆ·æµå¤±æƒ…å†µ" class="section level2">
<h2>2.2 ä»¥å·ä¸ºå•ä½æŸ¥çœ‹å®¢æˆ·æµå¤±æƒ…å†µ</h2>
<p><span class="math inline">\(\quad\quad\)</span>è¿™é‡Œæ˜¯æœ¬ç¯‡çš„é‡ç‚¹ï¼Œæˆ‘ä»¬å°†å°è¯•ç”¨Rè¯­è¨€ggplotè¿›è¡Œåœ°ç†ä¿¡æ¯å¯è§†åŒ–ã€‚</p>
<p><span class="math inline">\(\quad\quad\)</span>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è¯»å–ç¾å¸å„å·è¾¹ç•Œshpæ ¼å¼æ–‡ä»¶ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯shpæ–‡ä»¶ï¼Ÿ</p>
<p><span class="math inline">\(\quad\quad\)</span>Shapefileå±äºä¸€ç§çŸ¢é‡å›¾å½¢æ ¼å¼ï¼Œå®ƒèƒ½å¤Ÿä¿å­˜å‡ ä½•å›¾å½¢çš„ä½ç½®åŠç›¸å…³å±æ€§ã€‚ä½†è¿™ç§æ ¼å¼æ²¡æ³•å­˜å‚¨åœ°ç†æ•°æ®çš„æ‹“æ‰‘ä¿¡æ¯ã€‚Shapefileåœ¨ä¹åå¹´ä»£åˆçš„ArcView GISçš„ç¬¬äºŒä¸ªç‰ˆæœ¬è¢«é¦–æ¬¡åº”ç”¨ã€‚ç›®å‰ï¼Œè®¸å¤šè‡ªç”±çš„ç¨‹åºæˆ–å•†ä¸šçš„ç¨‹åºéƒ½å¯ä»¥è¯»å–Shapefileã€‚</p>
<p><span class="math inline">\(\quad\quad\)</span>Shapefileæ–‡ä»¶æŒ‡çš„æ˜¯ä¸€ç§æ–‡ä»¶å­˜å‚¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šè¯¥ç§æ–‡ä»¶æ ¼å¼æ˜¯ç”±å¤šä¸ªæ–‡ä»¶ç»„æˆçš„ã€‚å…¶ä¸­ï¼Œè¦ç»„æˆä¸€ä¸ªShapefileï¼Œæœ‰ä¸‰ä¸ªæ–‡ä»¶æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯â€œ.shpâ€, â€œ.shxâ€ä¸ â€œ.dbfâ€æ–‡ä»¶ã€‚è¡¨ç¤ºåŒä¸€æ•°æ®çš„ä¸€ç»„æ–‡ä»¶å…¶æ–‡ä»¶åå‰ç¼€åº”è¯¥ç›¸åŒã€‚ä¾‹å¦‚ï¼Œå­˜å‚¨ä¸€ä¸ªå…³äºæ¹–çš„å‡ ä½•ä¸å±æ€§æ•°æ®ï¼Œå°±å¿…é¡»æœ‰lake.shpï¼Œlake.shxä¸lake.dbfä¸‰ä¸ªæ–‡ä»¶ã€‚è€Œå…¶ä¸­â€œçœŸæ­£â€çš„Shapefileçš„åç¼€ä¸ºshpï¼Œç„¶è€Œä»…æœ‰è¿™ä¸ªæ–‡ä»¶æ•°æ®æ˜¯ä¸å®Œæ•´çš„ï¼Œå¿…é¡»è¦æŠŠå…¶ä»–ä¸¤ä¸ªé™„å¸¦ä¸Šæ‰èƒ½æ„æˆä¸€ç»„å®Œæ•´çš„åœ°ç†æ•°æ®ã€‚é™¤äº†è¿™ä¸‰ä¸ªå¿…é¡»çš„æ–‡ä»¶ä»¥å¤–ï¼Œè¿˜æœ‰å…«ä¸ªå¯é€‰çš„æ–‡ä»¶ï¼Œä½¿ç”¨å®ƒä»¬å¯ä»¥å¢å¼ºç©ºé—´æ•°æ®çš„è¡¨è¾¾èƒ½åŠ›ã€‚</p>
<span class="math inline">\(\quad\quad\)</span>æˆ‘ä»¬å·²ç»ä»<a href="https://gadm.org/">GADMä¸»é¡µ</a>ä¸‹è½½å¾—åˆ°äº†ç¾å›½ä¸‰çº§åœ°ç†è¾¹ç•Œæ•°æ®ï¼Œå­˜æ”¾åœ¨data/ä¸‹(å›¾ <a href="#fig:fig2">2</a>))ã€‚
<div class="figure" style="text-align: center"><span id="fig:fig2"></span>
<img src="pic/shp1.png" alt="æ–‡ä»¶ç›®å½•" width="322" />
<p class="caption">
å›¾ 2: æ–‡ä»¶ç›®å½•
</p>
</div>
<p><span class="math inline">\(\quad\quad\)</span>æˆ‘ä»¬æŒ‰éœ€è¯»å–å·çº§åœ°ç†è¾¹ç•Œæ•°æ®ï¼š</p>
<pre class="r"><code>library(maptools)
USA_map &lt;- readShapePoly(&quot;data/gadm36_USA_shp/gadm36_USA_1.shp&quot;)</code></pre>
<center>
<img src = 'pic/USA_map.png' alt = 'USA_mapæƒ…å†µ' width = 80%>
</center>
<p><span class="math inline">\(\quad\quad\)</span>ç»™åç§°è¡¨USA_map_dataæ·»åŠ ä¸€ä¸ªidåˆ—ä¸ç»çº¬åº¦è¡¨è¿›è¡Œè¿æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå«æœ‰å„å·ç»çº¬åº¦çš„DTï¼š</p>
<pre class="r"><code># fortifyæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºmodel or other R object to convert to data frame.
USA_map_data &lt;- setDT(USA_map@data)
USA_map_data[,id:=as.character(seq(0,.N-1))]
USA_map_fortify&lt;-setDT(fortify(USA_map))</code></pre>
<pre><code>## Regions defined for each Polygons</code></pre>
<p><span class="math inline">\(\quad\quad\)</span>ä½¿ç”¨data.tableè¿›è¡Œæ•°æ®æ•´ç†ï¼Œä½¿ç”¨ggplotç»˜åˆ¶æœ€ç»ˆçš„å›¾åƒ(å›¾ <a href="#fig:fig3">3</a>)ï¼š</p>
<pre class="r"><code>#åŸºäºidè¿›è¡Œè¿æ¥
USA_map_merge &lt;- merge.data.table(USA_map_data,USA_map_fortify,all = T)

# ç”Ÿæˆä¸€ä¸ªå·åç¼©å†™-idçš„å¯¹åº”è¡¨ï¼Œåƒè¿™æ ·ï¼š
# AL-0
# AK-1
# AZ-2
state_info &lt;- USA_map_data[,.(HASC_1,id)] 
state_info[,HASC_1:=str_sub(HASC_1,4,)]

# step1è®¡ç®—å®¢æˆ·æµå¤±ç‡
dt_ratio &lt;- dt_churn_train[,.(ratio = sum(churn == &#39;yes&#39;)/.N ),by=state]

# step2å‘æµå¤±ç‡è¡¨æ·»åŠ id(ç”¨åˆ°ä¸Šé¢ç”Ÿæˆçš„state_info)
dt_ratio &lt;- merge.data.table(x= dt_ratio,y =state_info,by.x = &#39;state&#39;,by.y = &#39;HASC_1&#39;,all = T)

# å°†ratioæ·»åŠ åˆ°USA_map_mergeé‡Œ
USA_map_merge &lt;- merge.data.table(USA_map_merge,dt_ratio,by = &#39;id&#39;,all = T)

# å‚æ•°fill = ratioä¸ºæˆ‘ä»¬è¦å±•ç°çš„æ•°æ®æŒ‡æ ‡ï¼ŒåŸºäºè¯¥æŒ‡æ ‡ç»˜åˆ¶çƒ­åŠ›å›¾
# å‚æ•°group = groupç”¨äºåˆ†ç»„ï¼Œå°†ç»çº¬åº¦æ•°æ®åˆ†ç»™å„ä¸ªå·
ggplot(USA_map_merge,aes(x=long,y=lat,group=group,fill=ratio))+
  geom_polygon(colour=&quot;grey40&quot;)+
  scale_fill_gradient(low=&quot;white&quot;,high=&quot;red&quot;)+
  #coord_map(&quot;polyconic&quot;)+
  theme(
    panel.grid=element_blank(),
    panel.background=element_blank(),
    axis.text=element_blank(),
    axis.ticks=element_blank(),
    axis.title=element_blank(),
    legend.position=c(0.4,0.4),
  )</code></pre>
<div class="figure" style="text-align: center"><span id="fig:fig3"></span>
<img src="{{< blogdown/postref >}}index.en_files/figure-html/fig3-1.png" alt="åˆå¤§åˆä¸‘çš„åœ°å›¾" width="672" />
<p class="caption">
å›¾ 3: åˆå¤§åˆä¸‘çš„åœ°å›¾
</p>
</div>
<p><span class="math inline">\(\quad\quad\)</span>ä¸Šé¢è¿™ä¸ªå›¾åˆå¤§åˆä¸‘ï¼Œè€ƒè™‘å°†é˜¿æ‹‰æ–¯åŠ ã€å¤å¨å¤·å»æ‰ï¼Œçœ‹æ–°çš„å›¾ <a href="#fig:fig4">4</a>ï¼š</p>
<pre class="r"><code>AnotherTest &lt;- USA_map_merge[NAME_1 != &#39;Hawaii&#39; &amp; NAME_1 != &#39;Alaska&#39;]
ggplot(AnotherTest,aes(x=long,y=lat,group=group,fill=ratio))+
  geom_polygon(colour=&quot;grey40&quot;)+
  scale_fill_gradient(low=&quot;white&quot;,high=&quot;red&quot;)+
  #coord_map(&quot;polyconic&quot;)+
  theme(
    panel.grid=element_blank(),
    panel.background=element_blank(),
    axis.text=element_blank(),
    axis.ticks=element_blank(),
    axis.title=element_blank(),
    # legend.position=c(0.4,0.4),
  )</code></pre>
<div class="figure" style="text-align: center"><span id="fig:fig4"></span>
<img src="{{< blogdown/postref >}}index.en_files/figure-html/fig4-1.png" alt="æ–°å›¾" width="672" />
<p class="caption">
å›¾ 4: æ–°å›¾
</p>
</div>
<center>
<img src = 'pic/å¦™å•Š.jpg' alt = 'å¦™å•Šï¼' width = 80%>
</center>
<p><span class="math inline">\(\quad\quad\)</span>æ ¹æ®å¯è§†åŒ–ç»“æœï¼Œå®¢æˆ·æµå¤±ç‡å› å·è€Œå¼‚ã€‚ ä»»ä½•æœ‰å…³å‡å°‘æµå¤±çš„æè®®éƒ½åº”è¯¥æ›´å¤šåœ°å…³æ³¨æµå¤±ç‡é«˜äºå¹³å‡æ°´å¹³çš„å·ã€‚ <strong>é‚£äº›æµå¤±ç‡Top20å·æ˜¯ï¼š</strong></p>
<pre class="r"><code>top20 &lt;- setorder(dt_ratio,-ratio) %&gt;% head(20)
top20$state</code></pre>
<pre><code>##  [1] &quot;CA&quot; &quot;NJ&quot; &quot;TX&quot; &quot;MD&quot; &quot;SC&quot; &quot;MI&quot; &quot;MS&quot; &quot;NV&quot; &quot;WA&quot; &quot;ME&quot; &quot;MT&quot; &quot;AR&quot; &quot;KS&quot; &quot;NY&quot; &quot;MN&quot;
## [16] &quot;PA&quot; &quot;MA&quot; &quot;CT&quot; &quot;NC&quot; &quot;NH&quot;</code></pre>
<p><span class="math inline">\(\quad\quad\)</span>å¦‚æœåªç”¨ggplotç»˜åˆ¶åœ°å›¾ï¼Œå°±æ›´ç®€å•äº†ï¼Œç²¾ç®€æ­¥éª¤å³å¯ã€‚</p>
</div>
</div>
